#!/bin/sh

if [ ! "$QBHOME" ]; then
    PRG=$0
    
    progdir=`dirname "$PRG"`
    
    if [ "`echo "$progdir" | grep -s '^/'`" ]; then
        progdir=$progdir
    else
        progdir=`pwd`/"$progdir"
    fi
    
    QBHOME=`echo "$progdir" | sed 's:/bin$::'`
    export QBHOME
fi

echo "What is QBENVSET? " $QBENVSET
if [ -z "$QBENVSET" ]; then
echo "in if for QBENVSET? " $QBENVSET
    . $QBHOME/etc/qbenv.sh
fi
    
# below we will set to hard-coded machine file. This could be done on the qbenv.sh file.
if [ -e "qbmachinefile.txt" ] ; then
    QBMACHINEFILE="-machinefile qbmachinefile.txt" ; export QBMACHINEFILE
elif [ ! -z "${PBS_NODEFILE}" ]; then
# NOTE!! We should use mpirun technologies as per ticket #553 instead of doing it this way.
    QBMACHINEFILE="-machinefile ${PBS_NODEFILE}" ; export QBMACHINEFILE
else
# note: we need an empty QBMACHINEFILE variable for the mpirun below so we don't need to maintain two calls.
    QBMACHINEFILE="" ; export QBMACHINEFILE  
fi

mpirun -x QBHOME -x PATH -x LD_LIBRARY_PATH -x MKL_NUM_THREADS -x MKL_DYNAMIC ${QBMACHINEFILE} moedivconmpi.bin $@ - 
