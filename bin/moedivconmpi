#!/bin/bash

if [ ! "$QBHOME" ]; then
    PRG=$0
    
    progdir=`dirname "$PRG"`
    
    if [ "`echo "$progdir" | grep -s '^/'`" ]; then
        progdir=$progdir
    else
        progdir=`pwd`/"$progdir"
    fi
    
    QBHOME=`echo "$progdir" | sed 's:/bin$::'`
    export QBHOME
fi

if [ -z "$QBENVSET" ]; then
    . $QBHOME/etc/qbenv.sh
fi
    
# below we will set to hard-coded machine file if the user does not provide a machine file on the comand line.
if [ -e "qbmachinefile.txt" ] ; then
    QBMACHINEFILE="-machinefile qbmachinefile.txt"
elif [ ! -z "${PBS_NODEFILE}" ]; then
# NOTE!! We should use mpirun technologies as per ticket #553 instead of doing it this way.
    QBMACHINEFILE="-machinefile ${PBS_NODEFILE}"
else
# We need an empty QBMACHINEFILE variable for the mpirun below so we don't need to maintain two calls.
    QBMACHINEFILE=""
fi

exec "${QBHOME}/bin/mpirun" "-x OPAL_PREFIX -x QBHOME -x PATH -x LD_LIBRARY_PATH -x MKL_NUM_THREADS -x MKL_DYNAMIC ${QBMACHINEFILE} ${QBHOME}/bin/moedivconmpi.bin" "$@ -" 
