#!/bin/bash

doProtonate=0
cutRadius=5

if [ ! "$QBHOME" ]; then
    PRG=$0
    
    progdir=`dirname "$PRG"`
    if [ "$progdir" = "." ]; then
	    progdir=`pwd`
    fi
    
    if [ "`echo "$progdir" | grep -s '^/'`" ]; then
        progdir=$progdir
    else
        progdir=`pwd`/"$progdir"
    fi
    
    QBHOME=`echo "$progdir" | sed 's:/bin$::'`
    export QBHOME
fi

errorOut()
{
    test $doProtonate -eq 1 && prProt="enabled" || prProt="disabled"

    echo
    echo "Usage: runNMRcomplex.sh --complex=FILENAME"
#   echo "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
    echo
    echo "REQUIRED Command line arguments:"
    echo "  --complex=FILENAME  * File corresponding to protein/ligand complex"
    echo
    echo "Optional Command line arguments:"
    echo "  --radius=#          * Radius around ligand to include.  Default=${cutRadius}"
    echo "  --enableProtonate   * enable protonation                Default=${prProt}"
    echo
    echo "For help, email support@quantumbioinc.com"
    echo 
    exit 1
}

while test $# -gt 0 ; do
    case "$1" in
        -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
        *) optarg= ;;
    esac
    case $1 in
        --help)
            errorOut
            ;;
        --radius=*)
            cutRadius=$optarg
            ;;
        --enableProtonate)
            doProtonate=1
            ;;
        --disableProtonate)
            doProtonate=0
            ;;
        --complex=*)
            inFile=$optarg
            ;;
        *)
            echo "ERROR: $optarg option not available for --build..."
            errorOut
        esac
    shift
done

filename=$(basename "$inFile")
extension="${filename##*.}"
filename="${filename%.*}"

if [ -z "$inFile" ] ; then
    errorOut
fi

MOEARGS="['$inFile',[],[enableOpt:0,enableProtonate:$doProtonate,enableLigFix:1,enableCropOnLig:1,qmcrop_radius:$cutRadius]]"
echo $MOEARGS

${QBHOME}/bin/qbmoebatch moebatch -exec "run ['$QBHOME/svl/qbPrep2Files.svl',$MOEARGS,'qbPrep2Files']" -exit

# divcon -i mp_${filename}.mol2 -I 

