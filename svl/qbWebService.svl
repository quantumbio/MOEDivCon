#svl

#set main qbPostData

function qbParseJSON;

// const QB_URL = 'http://localhost:8080';
 const QB_URL = 'http://shadowfax.quantumbioinc.com:8080';
// const QB_URL = 'http://shadowfax.quantumbioinc.com:8888';

local function OLDRCSB_post [QB_URL, query]
//    const POST_CONTENT = 'dodododod';
//    query = tok_cat ["--dodododod
    local myproperties = [
            'Content-Disposition': "form-data; name=\"Instructions\"",
            'Content-Type': "text/plain"
        ];

    const POST_CONTENT =
#token
--3d84b97c-a562-4535-8a06-421fa7742d07\r
Content-Disposition: form-data; name="Instructions"
Content-Type: text/plain

{"target":"1HWI.pdb"}
--3d84b97c-a562-4535-8a06-421fa7742d07
Content-Disposition: form-data; name="TargetContent"
Content-Type: text/plain

REMARK Date 2014-07-19 Time 20:43:17 EDT -0400 (1405816997.26 s)
REMARK PHENIX refinement
REMARK 
REMARK ****************** INPUT FILES AND LABELS ******************************
REMARK Reflections:
REMARK   file name      : 3FVA.mtz
REMARK   labels         : ['FP,SIGFP']
REMARK R-free flags:
REMARK   file name      : 3FVA.mtz
REMARK   label          : FREE
REMARK   test_flag_value: 0
REMARK Model file name(s): 
REMARK   /home/oleg/TEST/standard_phen_tests/3FVA/phen1309/phenix/3FVA.pdb
REMARK 
REMARK ******************** REFINEMENT SUMMARY: QUICK FACTS *******************
REMARK Start: r_work = 0.1452 r_free = 0.1507 bonds = 0.008 angles = 0.773
REMARK Final: r_work = 0.1398 r_free = 0.1540 bonds = 0.008 angles = 0.718
REMARK ************************************************************************
REMARK 
REMARK ****************** REFINEMENT STATISTICS STEP BY STEP ******************
REMARK leading digit, like 1_, means number of macro-cycle                     
REMARK 0    : statistics at the very beginning when nothing is done yet        
REMARK 1_bss: bulk solvent correction and/or (anisotropic) scaling             
REMARK 1_xyz: refinement of coordinates                                        
REMARK 1_adp: refinement of ADPs (Atomic Displacement Parameters)              
REMARK 1_occ: refinement of occupancies                                        
REMARK ------------------------------------------------------------------------
REMARK  stage       r-work r-free bonds angles b_min b_max b_ave n_water shift
REMARK       0    : 0.1526 0.1563 0.008  0.77   0.0  11.1   0.7   6      0.000
REMARK       1_bss: 0.1452 0.1507 0.008  0.77   0.0  11.1   0.7   6      0.000
REMARK 1_settarget: 0.1452 0.1507 0.008  0.77   0.0  11.1   0.7   6      0.000
REMARK    1_weight: 0.1452 0.1507 0.008  0.77   0.0  11.1   0.7   6      0.000
REMARK       1_nqh: 0.1452 0.1507 0.008  0.77   0.0  11.1   0.7   6      0.000
REMARK    1_xyzrec: 0.1400 0.1569 0.007  0.72   0.0  11.1   0.7   6      0.083
REMARK   1_regHxyz: 0.1413 0.1563 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK       1_adp: 0.1413 0.1563 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK   1_regHadp: 0.1413 0.1559 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK       2_bss: 0.1400 0.1552 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK 2_settarget: 0.1400 0.1552 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK    2_weight: 0.1400 0.1552 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK       2_nqh: 0.1400 0.1552 0.007  0.72   0.0  11.1   0.7   6      0.089
REMARK    2_xyzrec: 0.1400 0.1554 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK   2_regHxyz: 0.1405 0.1547 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK       2_adp: 0.1405 0.1547 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK   2_regHadp: 0.1405 0.1547 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK       3_bss: 0.1404 0.1543 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK 3_settarget: 0.1404 0.1543 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK    3_weight: 0.1404 0.1543 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK       3_nqh: 0.1404 0.1543 0.007  0.70   0.0  11.1   0.7   6      0.092
REMARK    3_xyzrec: 0.1395 0.1540 0.008  0.72   0.0  11.1   0.7   6      0.092
REMARK   3_regHxyz: 0.1398 0.1538 0.008  0.72   0.0  11.1   0.7   6      0.092
REMARK       3_adp: 0.1398 0.1538 0.008  0.72   0.0  11.1   0.7   6      0.092
REMARK   3_regHadp: 0.1398 0.1538 0.008  0.72   0.0  11.1   0.7   6      0.092
REMARK         end: 0.1398 0.1540 0.008  0.72   0.0  11.1   0.7   6      0.092
REMARK ------------------------------------------------------------------------
REMARK MODEL CONTENT.
REMARK  ELEMENT        ATOM RECORD COUNT   OCCUPANCY SUM
REMARK        H                       47           47.00
REMARK        C                       30           30.00
REMARK      O1-                        1            1.00
REMARK        O                       13           13.00
REMARK        N                       10           10.00
REMARK    TOTAL                      101          101.00
REMARK -----------------------------------------------------------------------
REMARK r_free_flags.md5.hexdigest 5570565c7a2caf543420e874a8e4aad6
REMARK 
REMARK IF THIS FILE IS FOR PDB DEPOSITION: REMOVE ALL FROM THIS LINE UP.
REMARK   3
REMARK   3 REFINEMENT.
REMARK   3   PROGRAM     : PHENIX (phenix.refine: 1.9_1692)
REMARK   3   AUTHORS     : Adams,Afonine,Burnley,Chen,Davis,Echols,Gildea,
REMARK   3               : Gopal,Gros,Grosse-Kunstleve,Headd,Hung,Immormino,
REMARK   3               : Ioerger,McCoy,McKee,Moriarty,Pai,Read,Richardson,
REMARK   3               : Richardson,Romo,Sacchettini,Sauter,Smith,Storoni,
REMARK   3               : Terwilliger,Zwart
REMARK   3
REMARK   3  REFINEMENT TARGET : LS_WUNIT_K1
REMARK   3  
REMARK   3  DATA USED IN REFINEMENT.
REMARK   3   RESOLUTION RANGE HIGH (ANGSTROMS) : 1.458   
REMARK   3   RESOLUTION RANGE LOW  (ANGSTROMS) : 14.931  
REMARK   3   MIN(FOBS/SIGMA_FOBS)              : 1.40  
REMARK   3   COMPLETENESS FOR RANGE        (%) : 97.77 
REMARK   3   NUMBER OF REFLECTIONS             : 745       
REMARK   3   NUMBER OF REFLECTIONS (NON-ANOMALOUS) : 745       
REMARK   3  
REMARK   3  FIT TO DATA USED IN REFINEMENT.
REMARK   3   R VALUE     (WORKING + TEST SET) : 0.1410
REMARK   3   R VALUE            (WORKING SET) : 0.1398
REMARK   3   FREE R VALUE                     : 0.1540
REMARK   3   FREE R VALUE TEST SET SIZE   (%) : 5.37  
REMARK   3   FREE R VALUE TEST SET COUNT      : 40        
REMARK   3  
REMARK   3  FIT TO DATA USED IN REFINEMENT (IN BINS).
REMARK   3   BIN  RESOLUTION RANGE  COMPL.    NWORK NFREE   RWORK  RFREE
REMARK   3     1 14.9313 -  1.4583    0.98      705    40  0.1398 0.1540
REMARK   3  
REMARK   3  BULK SOLVENT MODELLING.
REMARK   3   METHOD USED        : FLAT BULK SOLVENT MODEL
REMARK   3   SOLVENT RADIUS     : 1.11    
REMARK   3   SHRINKAGE RADIUS   : 0.90    
REMARK   3   GRID STEP FACTOR   : 4.00    
REMARK   3  
REMARK   3  ERROR ESTIMATES.
REMARK   3   COORDINATE ERROR (MAXIMUM-LIKELIHOOD BASED)     : 0.14    
REMARK   3   PHASE ERROR (DEGREES, MAXIMUM-LIKELIHOOD BASED) : 12.57   
REMARK   3  
REMARK   3  STRUCTURE FACTORS CALCULATION ALGORITHM : FFT
REMARK   3  
REMARK   3  DEVIATIONS FROM IDEAL VALUES.
REMARK   3                 RMSD     MAX  COUNT
REMARK   3   BOND      :  0.008   0.022     52
REMARK   3   ANGLE     :  0.718   2.656     70
REMARK   3   CHIRALITY :  0.049   0.083      7
REMARK   3   PLANARITY :  0.005   0.011     11
REMARK   3   DIHEDRAL  : 15.540  45.729     18
REMARK   3   MIN NONBONDED DISTANCE : 2.683 
REMARK   3  
REMARK   3  MOLPROBITY STATISTICS.
REMARK   3   ALL-ATOM CLASHSCORE : 0.00  
REMARK   3   RAMACHANDRAN PLOT:
REMARK   3     OUTLIERS : 0.00  %
REMARK   3     ALLOWED  : 0.00  %
REMARK   3     FAVORED  : 100.00 %
REMARK   3   ROTAMER OUTLIERS : 0.00 %
REMARK   3   CBETA DEVIATIONS : 0
REMARK   3  
REMARK   3  ATOMIC DISPLACEMENT PARAMETERS.
REMARK   3   WILSON B : 2.72
REMARK   3   RMS(B_ISO_OR_EQUIVALENT_BONDED) : 0.58
REMARK   3   ATOMS          NUMBER OF ATOMS
REMARK   3                    ISO.  ANISO. 
REMARK   3    ALL         :    101       0
REMARK   3    ALL (NO H)  :     54       0
REMARK   3    SOLVENT     :      2       0
REMARK   3    NON-SOLVENT :     52       0
REMARK   3    HYDROGENS   :     47       0
REMARK   3
CRYST1   18.061    4.840   21.362  90.00 100.10  90.00 P 1 21 1
SCALE1      0.055368  0.000000  0.009863        0.00000
SCALE2      0.000000  0.206612  0.000000        0.00000
SCALE3      0.000000  0.000000  0.047549        0.00000
ATOM      1  N   ASN A   1      -6.773  -0.235  -0.792  1.00  2.32           N
ATOM      2  CA  ASN A   1      -7.109  -0.466  -2.190  1.00  0.97           C
ATOM      3  C   ASN A   1      -6.118   0.225  -3.108  1.00  0.87           C
ATOM      4  O   ASN A   1      -6.099   1.444  -3.218  1.00  0.63           O
ATOM      5  CB  ASN A   1      -8.524   0.011  -2.515  1.00  1.13           C
ATOM      6  CG  ASN A   1      -9.606  -0.838  -1.864  1.00  1.36           C
ATOM      7  OD1 ASN A   1      -9.328  -1.826  -1.176  1.00  1.08           O
ATOM      8  ND2 ASN A   1     -10.850  -0.443  -2.072  1.00  2.36           N
ATOM      9  H1  ASN A   1      -6.789   0.708  -0.612  1.00  2.78           H
ATOM     10  H2  ASN A   1      -5.916  -0.593  -0.549  1.00  2.78           H
ATOM     11  HA  ASN A   1      -7.067  -1.419  -2.368  1.00  1.16           H
ATOM     12  HB2 ASN A   1      -8.654  -0.023  -3.476  1.00  1.36           H
ATOM     13  HB3 ASN A   1      -8.628   0.923  -2.200  1.00  1.36           H
ATOM     14 HD21 ASN A   1     -11.504  -0.883  -1.729  1.00  2.83           H
ATOM     15 HD22 ASN A   1     -11.006   0.255  -2.549  1.00  2.83           H
ATOM     16  N   ASN A   2      -5.320  -0.582  -3.792  1.00  0.00           N
ATOM     17  CA  ASN A   2      -4.241  -0.084  -4.633  1.00  0.00           C
ATOM     18  C   ASN A   2      -4.338  -0.718  -6.011  1.00  0.00           C
ATOM     19  O   ASN A   2      -4.449  -1.931  -6.134  1.00  0.00           O
ATOM     20  CB  ASN A   2      -2.898  -0.398  -3.983  1.00  0.00           C
ATOM     21  CG  ASN A   2      -2.768   0.225  -2.616  1.00  0.22           C
ATOM     22  OD1 ASN A   2      -2.936   1.436  -2.461  1.00  0.00           O
ATOM     23  ND2 ASN A   2      -2.547  -0.605  -1.603  1.00  2.58           N
ATOM     24  H   ASN A   2      -5.384  -1.440  -3.784  1.00  0.00           H
ATOM     25  HA  ASN A   2      -4.320   0.878  -4.729  1.00  0.00           H
ATOM     26  HB2 ASN A   2      -2.185  -0.051  -4.542  1.00  0.00           H
ATOM     27  HB3 ASN A   2      -2.809  -1.359  -3.887  1.00  0.00           H
ATOM     28 HD21 ASN A   2      -2.484  -1.450  -1.745  1.00  3.10           H
ATOM     29 HD22 ASN A   2      -2.465  -0.296  -0.804  1.00  3.10           H
ATOM     30  N   GLN A   3      -4.305   0.127  -7.036  1.00  0.00           N
ATOM     31  CA  GLN A   3      -4.492  -0.301  -8.429  1.00  0.00           C
ATOM     32  C   GLN A   3      -3.414   0.301  -9.315  1.00  0.00           C
ATOM     33  O   GLN A   3      -3.233   1.515  -9.337  1.00  0.00           O
ATOM     34  CB  GLN A   3      -5.870   0.134  -8.941  1.00  0.00           C
ATOM     35  CG  GLN A   3      -7.028  -0.518  -8.216  1.00  0.00           C
ATOM     36  CD  GLN A   3      -8.362   0.084  -8.605  1.00  0.00           C
ATOM     37  OE1 GLN A   3      -8.513   1.303  -8.669  1.00  0.59           O
ATOM     38  NE2 GLN A   3      -9.346  -0.770  -8.854  1.00  0.00           N
ATOM     39  H   GLN A   3      -4.174   0.973  -6.953  1.00  0.00           H
ATOM     40  HA  GLN A   3      -4.433  -1.268  -8.484  1.00  0.00           H
ATOM     41  HB2 GLN A   3      -5.942  -0.096  -9.881  1.00  0.00           H
ATOM     42  HB3 GLN A   3      -5.955   1.094  -8.831  1.00  0.00           H
ATOM     43  HG2 GLN A   3      -6.911  -0.400  -7.260  1.00  0.00           H
ATOM     44  HG3 GLN A   3      -7.048  -1.463  -8.435  1.00  0.00           H
ATOM     45 HE21 GLN A   3     -10.123  -0.477  -9.079  1.00  0.00           H
ATOM     46 HE22 GLN A   3      -9.207  -1.616  -8.790  1.00  0.00           H
ATOM     47  N   ASN A   4      -2.692  -0.548 -10.035  1.00  0.00           N
ATOM     48  CA  ASN A   4      -1.749  -0.085 -11.050  1.00  0.00           C
ATOM     49  C   ASN A   4      -2.006  -0.759 -12.398  1.00  0.00           C
ATOM     50  O   ASN A   4      -2.260  -1.960 -12.467  1.00  0.00           O
ATOM     51  CB  ASN A   4      -0.299  -0.340 -10.618  1.00  0.00           C
ATOM     52  CG  ASN A   4       0.693   0.181 -11.627  1.00  0.00           C
ATOM     53  OD1 ASN A   4       0.904   1.385 -11.738  1.00  0.00           O
ATOM     54  ND2 ASN A   4       1.304  -0.724 -12.377  1.00  0.00           N
ATOM     55  H   ASN A   4      -2.729  -1.403  -9.957  1.00  0.00           H
ATOM     56  HA  ASN A   4      -1.860   0.871 -11.169  1.00  0.00           H
ATOM     57  HB2 ASN A   4      -0.160  -1.295 -10.522  1.00  0.00           H
ATOM     58  HB3 ASN A   4      -0.136   0.109  -9.774  1.00  0.00           H
ATOM     59 HD21 ASN A   4       1.879  -0.476 -12.967  1.00  0.00           H
ATOM     60 HD22 ASN A   4       1.125  -1.559 -12.275  1.00  0.00           H
ATOM     61  N   THR A   5      -1.939   0.020 -13.468  1.00  0.00           N
ATOM     62  CA  THR A   5      -1.922  -0.552 -14.797  1.00  0.00           C
ATOM     63  C   THR A   5      -0.858   0.114 -15.670  1.00  0.00           C
ATOM     64  O   THR A   5      -0.665   1.331 -15.621  1.00  0.00           O
ATOM     65  CB  THR A   5      -3.317  -0.460 -15.489  1.00  0.18           C
ATOM     66  OG1 THR A   5      -3.218  -0.966 -16.819  1.00  2.35           O
ATOM     67  CG2 THR A   5      -3.828   0.961 -15.527  1.00  0.77           C
ATOM     68  H   THR A   5      -1.903   0.879 -13.448  1.00  0.00           H
ATOM     69  HA  THR A   5      -1.694  -1.491 -14.724  1.00  0.00           H
ATOM     70  HB  THR A   5      -3.954  -0.996 -14.992  1.00  0.22           H
ATOM     71 HG21 THR A   5      -3.916   1.306 -14.624  1.00  0.92           H
ATOM     72 HG22 THR A   5      -3.209   1.523 -16.020  1.00  0.92           H
ATOM     73 HG23 THR A   5      -4.694   0.990 -15.962  1.00  0.92           H
ATOM     74  HG1 THR A   5      -2.661  -0.516 -17.258  1.00  2.82           H
ATOM     75  N   PHE A   6      -0.166  -0.692 -16.465  1.00  0.00           N
ATOM     76  CA  PHE A   6       0.769  -0.175 -17.460  1.00  0.30           C
ATOM     77  C   PHE A   6       0.032   0.131 -18.781  1.00  1.10           C
ATOM     78  O   PHE A   6      -1.201  -0.072 -18.861  1.00  1.93           O
ATOM     79  CB  PHE A   6       1.935  -1.159 -17.658  1.00  0.11           C
ATOM     80  CG  PHE A   6       2.828  -1.266 -16.455  1.00  0.00           C
ATOM     81  CD1 PHE A   6       2.573  -2.200 -15.473  1.00  0.00           C
ATOM     82  CD2 PHE A   6       3.900  -0.411 -16.288  1.00  0.00           C
ATOM     83  CE1 PHE A   6       3.377  -2.288 -14.353  1.00  0.00           C
ATOM     84  CE2 PHE A   6       4.701  -0.490 -15.176  1.00  0.00           C
ATOM     85  CZ  PHE A   6       4.442  -1.429 -14.206  1.00  0.00           C
ATOM     86  OXT PHE A   6       0.613   0.605 -19.785  1.00  2.12           O1-
ATOM     87  H   PHE A   6      -0.219  -1.550 -16.448  1.00  0.00           H
ATOM     88  HA  PHE A   6       1.141   0.659 -17.131  1.00  0.36           H
ATOM     89  HB2 PHE A   6       2.476  -0.859 -18.405  1.00  0.13           H
ATOM     90  HB3 PHE A   6       1.575  -2.040 -17.843  1.00  0.13           H
ATOM     91  HD1 PHE A   6       1.851  -2.780 -15.567  1.00  0.00           H
ATOM     92  HD2 PHE A   6       4.079   0.230 -16.937  1.00  0.00           H
ATOM     93  HE1 PHE A   6       3.199  -2.926 -13.700  1.00  0.00           H
ATOM     94  HE2 PHE A   6       5.423   0.089 -15.082  1.00  0.00           H
ATOM     95  HZ  PHE A   6       4.989  -1.489 -13.457  1.00  0.00           H
TER
HETATM   96  O   HOH W   7      -4.954   1.974  -0.236  1.00  3.85           O
HETATM   97  H1  HOH W   7      -4.309   1.523  -0.529  1.00  4.62           H
HETATM   98  H2  HOH W   7      -5.383   2.247  -0.905  1.00  4.62           H
HETATM   99  O   HOH W   8       3.232   1.105 -20.647  1.00 11.11           O
HETATM  100  H1  HOH W   8       2.486   0.787 -20.427  1.00 13.33           H
HETATM  101  H2  HOH W   8       3.114   1.923 -20.794  1.00 13.33           H
TER
END
--3d84b97c-a562-4535-8a06-421fa7742d07--
#;


//    local url = url_open tok_cat [
//	first cat [QB_URL, QB_URL], '/qmechanic/perception'
//    ]; 
    local url = url_open [
        url: tok_cat [first cat [QB_URL, QB_URL], '/qmechanic/perception'],
        properties : myproperties
    ]; 
    url_write  [url, string tok_cat [POST_CONTENT]];
    local tmpJSON = url_read url;
    write ['JSON: {}\n', tmpJSON];
//    qbParseJSON [url_read url];
//    qbParseJSON[tmpJSON];
endfunction

function json_Create;
function json_Extract;
function qbWriteJSONStream;

global function qbTestPost []

    const boundary_chars = "-_1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    local boundary = sample [shuffle boundary_chars, 40];
    local ctype = cat ["multipart/form-data; boundary=", boundary];
    boundary = cat ["--", boundary]; // add two dashes by the standards
    const CRLF = "\r\n";
    
    local Instructions = cat [
        boundary, CRLF,
        "Content-Disposition: form-data; name=\"instructions\"", CRLF,
        "Content-Type: text/plain", CRLF,
        CRLF,
        "{ \"options\": {\"scoretype\": \"endpoint\"}}", CRLF
    ];
    
    local TargetContent = cat [
        boundary, CRLF,
        "Content-Disposition: form-data; name=\"Target\"", CRLF,
        "Content-Type: text/plain", CRLF,
        CRLF,
        string twrite ['{}',qbWriteJSONStream json_Extract diff [Atoms[], _Atoms '$$ligand']], CRLF
    ];
    
    local LigandContent = cat [
        boundary, CRLF,
        "Content-Disposition: form-data; name=\"Ligand\"", CRLF,
        "Content-Type: text/plain", CRLF,
        CRLF,
        string twrite ['{}',qbWriteJSONStream json_Extract _Atoms '$$ligand'], CRLF    
    ];

    local POST_CONTENT = cat [
        Instructions,
        TargetContent,
        LigandContent,
        boundary, "--", CRLF
    ];

    local postlen = length string POST_CONTENT;
    write ['size: {}\n', postlen];
    
    fwrite ['del-debug-POST.txt', '{}\n', POST_CONTENT];
    local url = curl_open [
        url: tok_cat [QB_URL, '/qmechanic/movabletype'],
        infilesize: postlen,
        httpheader: [ 'Transfer-Encoding: Chunked', 
                 'TargetName: target.json',
                 'LigandName: ligand.json']
    ]; 
    curl_write  [url, POST_CONTENT];
    local tmpJSON = curl_read url;
    write ['RETURN JSON: {}\n', tmpJSON];

endfunction

#eof
